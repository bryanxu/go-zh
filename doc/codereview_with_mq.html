<!--{
	"Title": "使用Mercurial队列进行代码审查"
}-->

<h2 id="前言">前言</h2>

<p>
Mercurial队列（<code>mq</code>）为管理Mercurial代码库顶端的补丁提供了一种机制，
它的细节描述在<a href="http://hgbook.red-bean.com/read/">Mercurial：最后的指南</a>第
<a href="http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html">12</a>
及第<a href="http://hgbook.red-bean.com/read/advanced-uses-of-mercurial-queues.html">13</a>章中。
本文档说明了如何使 <code>mq</code> 与<a href="contribute.html">为Go项目做贡献</a>说明中描述的
<code>codereview</code> Mercurial扩展协同工作。本文假定你已经阅读了那些说明。
</p>

<h2>配置</h2>

<p>
要启用 <code>mq</code>，请编辑 <code>$HOME/.hgrc</code>（为你的所有代码库启用）或
<code>$GOROOT/.hg/hgrc</code>（为 <code>$GOROOT</code>中的代码库启用），添加：
</p>

<pre>
[extensions]
mq=
</pre>

<p>
在 <code>mq</code> 补丁被应用时，进行拉取、推送、更新或提交会损坏你本地或远程的代码库，
添加以下几行来避免此情况的发生：
</p>

<pre>
[hooks]
# 若MQ补丁被应用则阻止"hg pull"
prechangegroup.mq-no-pull = ! hg qtop > /dev/null 2>&amp;1
# 若MQ补丁被应用则阻止"hg push"
preoutgoing.mq-no-push = ! hg qtop > /dev/null 2>&amp;1
# 若MQ补丁被应用则阻止"hg update"
preupdate.mq-no-update = ! hg qtop > /dev/null 2>&amp;1
</pre>

<h2>进行一次更改</h2>

<p>
整体被检出的树是可写的，根据“指南”中第
<a href="http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html">12</a>章的文档，
你可以使用 <code>mq</code> 来将你的更改作为单个补丁或一系列补丁来实现。
</p>

<p>当你准备好为审查发送出一个更改时，可在你的Go代码库中任何目录下运行</p>

<pre>
$ hg change
</pre>

<p>
将应用关于你更改的所有 <code>mq</code> 补丁，然后按照<a href="contribute.html">为Go项目做贡献</a>中的指示处理。
</p>

<p>
The change number reported by <code>hg change</code>, preceded by a <code>+</code>,
由 <code>hg change</code> 报告的更改数加上 <code>+</code> 前缀，可作为 <code>mq</code> 补丁来监视辅助控制，
该补丁根据“指南”中第<a href="http://hgbook.red-bean.com/read/advanced-uses-of-mercurial-queues.html">13</a>
章的描述来应用。例如，命令：
</p>

<pre>
for p in $(hg qapplied); do hg qguard $p +99999; done
</pre>

<p>
将应用监视 <code>+99999</code> 来监视当前所有 <code>mq</code> 补丁的应用。
</p>

<h2>同步你的客户端</h2>

<p>
当你工作时，其他人何能将更改提交至代码库，且根据<a href="contribute.html">为Go项目做贡献</a>中的解释，
在向代码审查发送你的更改列表前，必须使用 <code>hg sync</code> 来同步你的代码库。由于 <code>hg sync</code>
会运行 <code>hg pull -u</code>，因此你不应该在 <code>mq</code>补丁应用时运行 <code>hg sync</code>，
而是在运行 <code>hg sync</code> 前抛出你所有的补丁，并在它完成后重新应用它们。
</p>

<p>
在重新应用补丁时，你可能需要根据<a href="contribute.html">为Go项目做贡献</a>中的描述来解决冲突。
</p>

<h2>为审查而发送更改</h2>

<p>
在运行 <code>hg mail</code> 时，你应当拥有所有关于你更改应用的 <code>mq</code> 补丁。
</p>

<h2>在审查之后提交更改。</h2>

<p>
若你是一个提交者，在运行 <code>hg commit</code> 时，你应当拥有所有关于你更改应用的 <code>mq</code> 补丁。
</p>
