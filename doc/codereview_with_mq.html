<!--{
	"Title": "使用Mercurial队列进行代码检查"
}-->

<h2 id="前言">前言</h2>

<p>
Mercurial队列（<code>mq</code>）为管理Mercurial代码库顶部的补丁提供一种机制，
它的细节描述在<a href="http://hgbook.red-bean.com/read/">Mercurial：最后的指南</a>第
<a href="http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html">12</a>
及第<a href="http://hgbook.red-bean.com/read/advanced-uses-of-mercurial-queues.html">13</a>章中。
本文档说明了如何使 <code>mq</code> 与<a href="contribute.html">为Go项目做贡献</a>说明中描述的
<code>codereview</code> Mercurial扩展协同工作。本文假定你已经阅读了那些说明。
</p>

<h2>配置</h2>

<p>
要启用 <code>mq</code>，请编辑 <code>$HOME/.hgrc</code>（为你的所有代码库启用）或
<code>$GOROOT/.hg/hgrc</code>（为 <code>$GOROOT</code>中的代码库启用），添加：
</p>

<pre>
[extensions]
mq=
</pre>

<p>
在 <code>mq</code> 补丁被应用时，进行拉取、推送、更新或提交会损坏你本地或远程的代码库，
添加以下几行来避免此情况的发生：
</p>

<pre>
[hooks]
# 若MQ补丁被应用则阻止"hg pull"
prechangegroup.mq-no-pull = ! hg qtop > /dev/null 2>&amp;1
# 若MQ补丁被应用则阻止"hg push"
preoutgoing.mq-no-push = ! hg qtop > /dev/null 2>&amp;1
# 若MQ补丁被应用则阻止"hg update"
preupdate.mq-no-update = ! hg qtop > /dev/null 2>&amp;1
</pre>

<h2>进行一次更改</h2>

<p>
整体被检出的树是可写的，根据“指南”第
<a href="http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html">12</a>章的文档，
你可以使用 <code>mq</code> 来将你的更改作为单个补丁或一系列补丁来实现。
</p>

<p>当你准备好为检查发送出一个更改时，从你的Go代码库任何目录中运行</p>

<pre>
$ hg change
</pre>

<p>
将应用关于你更改的所有 <code>mq</code> 补丁，然后按照<a href="contribute.html">为Go项目做贡献</a>中的指示处理。
</p>

<p>
The change number reported by <code>hg change</code>, preceded by a <code>+</code>,
can be used as an <code>mq</code> patch guard to assist in controlling which patches
are applied as described in Chapter
<a href="http://hgbook.red-bean.com/read/advanced-uses-of-mercurial-queues.html">13</a>
of "The Guide".
For example, the command:
</p>

<pre>
for p in $(hg qapplied); do hg qguard $p +99999; done
</pre>

<p>
will apply the guard <code>+99999</code> guard to all currently applied <code>mq</code>
patches.
</p>

<h2>Synchronizing your client</h2>

<p>While you were working, others might have submitted changes
to the repository and, as explained in <a href="contribute.html">contributing
to the Go project</a>, it is necessary to synchronize your repository using
<code>hg sync</code>before sending your change list for review.
Because <code>hg sync</code> runs <code>hg pull -u</code>,
you should not run <code>hg sync</code> while <code>mq</code> patches are
applied. Instead
pop all your patches before running <code>hg sync</code> and reapply them after
it has completed.
</p>

<p>
When reapplying the patches, you may need to resolve conflicts
as described in <a href="contribute.html">contributing to the Go project</a>.
</p>

<h2>Mailing the change for review</h2>

<p>
You should have all of the <code>mq</code> patches relevant to your
change applied when you run <code>hg mail</code>.

<h2>Submitting the change after the review</h2>

If you are a committer, you should have all of the <code>mq</code> patches relevant to your
change applied when you run <code>hg commit</code>.
